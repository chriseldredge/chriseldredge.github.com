
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Chris Eldredge</title>
  <meta name="author" content="Chris Eldredge">

  
  <meta name="description" content="Last time
I talked about how my development team progressed from having all
of our .net code in a single repository with a single solution to using a &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://chriseldredge.github.com/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Chris Eldredge" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-30472598-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Chris Eldredge</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:chriseldredge.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/about/">About</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/08/20/how-the-motley-fool-uses-nuget-part-2/">How the Motley Fool Uses NuGet (Part 2)</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-08-20T13:56:00-04:00" pubdate data-updated="true">Aug 20<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="/blog/2012/08/07/how-the-motley-fool-uses-nuget/">Last time</a>
I talked about how my development team progressed from having all
of our .net code in a single repository with a single solution to using a more
modular architecture complete with encapsulated domains.</p>

<p>When we started using this appraoch, we were still limited in a few ways:</p>

<ul>
<li>Everyone needs to integrate with the newest code</li>
<li>Difficult to patch an old version of a dependency</li>
<li>Cascading failures on the build server</li>
</ul>


<p>Even though we broke the ProjectReference rats nest, we still had an
implicit dependency on various shared code. It all had to be checked out
and built in the right order.</p>

<h2>Binary Package Management</h2>

<p>The next logical step was to further decouple our shared code by
packaging it up and publishing those packages. If we could do that,
we could decide when to upgrade dependencies on a product by product
basis.</p>

<p>There are two package managers in the .net ecosystem: OpenWrap and NuGet.</p>

<p>When we started shopping around, OpenWrap had been around longer and seemed
to be a better choice. There&#8217;s a <a href="http://stackoverflow.com/questions/4256994/openwrap-vs-nuget">comparison of the products</a>
on stackoverflow.</p>

<p>We worked with OpenWrap for over 6 months and during that time started
to find some problems around integration with Visual Studio and ReSharper.
OpenWrap wants to manage dependencies per solution, and we have many cases
where we want to control dependencies at a per project level. We also
started to notice that NuGet was getting new versions released on a fairly
regular schedule, while OpenWrap 2.0 was in unstable beta limbo for over
a year.</p>

<p>Around the same time we started playing with <a href="http://octopusdeploy.com/">Octopus Deploy</a>
for deploying our code. Since Octopus uses NuGet packages for deployment, we
figured it would make sense to standardize on one package management system
for both deployments and dependency management. It&#8217;s true that those are
separate problem spaces, but having less build scripts is always a good thing.</p>

<h2>Thoughts on NuGet</h2>

<h3>Conventions</h3>

<p>NuGet has several conventions that make it easy to create simple packages
that others can reference. You can share assemblies and content easily,
and when you want to customize anything there are some powershell extension
points you can hook into.</p>

<p>One problem we run into is that when building packages, sometimes there&#8217;s
a NuGet convention we want to customize or suppress, and often we can&#8217;t.</p>

<p>For example, if you create a <code>nuspec</code> and place it adjacent to a <code>csproj</code>
file, NuGet will look at the project and automatically inject metadata
and content into the package. For some things, you can override this
behavior with explicit specifications in the nuspec, but the behavior
can be surprising and confusing.</p>

<h3>Dependency Scoping</h3>

<p>NuGet supports the concept of transitive dependencies&#8230; sort of. If you
install package A, and A depends on package B, NuGet will go find a version
of B and install it while installing A. However, NuGet doesn&#8217;t do any record
keeping to remember that B is a transitive dependency. To your project, A and
B appear simply as direct dependencies.</p>

<p>There may be cases where A depends on B at runtime, but consumers of A
shouldn&#8217;t need to code against B at design time.</p>

<p>There may be other cases where B is an optional dependency for A, and
A can be used without it.</p>

<p>Since NuGet doesn&#8217;t have a concept of scope, it only has one simplistic
approach to dealing with transitive dependencies: treat them just like
direct dependencies.</p>

<h3>Upgrade Behavior</h3>

<p>When you ask NuGet to update a specific package, it will first look for
updates to transitive dependencies that the package depends on. This may
seem obvious or desirable to some, but personally I find it confusing.
You can control this behavior with the <code>-IgnoreDependencies</code> flag in
the Package Manament Console, but oddly you don&#8217;t get that option
in the command line <code>nuget.exe</code> or from the Visual Studio GUI Package
Manager.</p>

<h3>Package Feed Performance</h3>

<p>We use continuous integration, and every successful build produces
&#8220;release candidate&#8221; versions of packages. We generate 50 to 100 packages
a day.</p>

<p>Using the simple NuGet UNC share quickly failed to scale, so next we tried
NuGet.Server and found that it doesn&#8217;t perform well either.</p>

<p>NuGet Gallery seemed like overkill with its SQL Server requirement, so
I started optimizing NuGet.Server. This project ended up taking quite
a while, but the good news is that the fruits of the labor are now
open source on GitHub at <a href="https://github.com/themotleyfool/NuGet">https://github.com/themotleyfool/NuGet</a>.</p>

<p>For more information about that project, see my <a href="/blog/2012/07/03/Speeding-Up-NuGet-Server/">previous post</a>.</p>

<h3>Refactoring Applications and Shared Code</h3>

<p>We try to use <a href="http://semver.org/">Semantic Versioning</a> to communicate
breaking changes in the packages we publish, so sometimes when
we want to use a refactoring tool like Change Method Signature
or Use Base Class it would be nice to have application and shared
code loaded into a single instance of Visual Studio.</p>

<p>We created a tool called <a href="https://github.com/TheMotleyFool/SlimJim">SlimJim</a>
that generates these Solution files on the fly.</p>

<p>If you create a Solution with application code and shared library code,
ReSharper will be smart enough to apply refactoring tools across the projects
even though ProjectReference style references are not being used.</p>

<p>However, Visual Studio won&#8217;t know the correct order to build projects in,
and won&#8217;t automatically copy outputs from shared libraries over to applications.</p>

<p>We extended SlimJim to convert assembly references to project references and back
to address this limitation.</p>

<h2>Conclusion</h2>

<p>In terms of capability and maturity, we&#8217;re in a much better place than
we were a few years ago. However, we still have a ways to go in terms of
productivity and workflow.</p>

<p>NuGet has helped us move in the right direction and we hope to see
further enhancements and even contribute some more of our own as we
develop them.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/08/07/how-the-motley-fool-uses-nuget/">How the Motley Fool Uses NuGet (Part 1)</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-08-07T14:25:00-04:00" pubdate data-updated="true">Aug 7<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This post describes how we came to using binary package management. In the next part I&#8217;ll get into NuGet.</p>

<p>In the beginning, there was one repository and it held all the projects for The Motley Fool, and it was good.
There were around a dozen asp.net web projects, a smattering of service and console apps, and a bunch of class libraries
to hold shared code. There was one Solution (sln) to rule them all.</p>

<p>As time went on, we found that there are downsides to the one-giant-solution approach to .net development:</p>

<ul>
<li><a href="http://www.laputan.org/mud/">Big Ball of Mud</a></li>
<li>Slow builds</li>
<li>Tight coupling</li>
<li>Configuration hell</li>
<li>Hard to release different applications on different schedules</li>
</ul>


<p>Typically our larger applications would be split into several projects following a typical N-tier layered architecture:</p>

<ul>
<li>Web</li>
<li>Service</li>
<li>Domain</li>
<li>Data Access</li>
</ul>


<p>Despite our attempts to encapsulate data access and domain logic behind the service project, code ended up leaking out
to the point where domain projects were using types and methods from unrelated domain projects. Cats and dogs were
sleeping together.</p>

<p>Around this time Steven Bohlen presented a <a href="http://unhandled-exceptions.com/blog/index.php/2010/11/27/dc-altnet-presentationthats-a-wrap/">talk</a>
to the Washington DC Alt.NET User Group titled &#8220;Domain Driven Design Implementation Patterns in .NET&#8221;. While some of us
were already familiar with concepts of DDD, this talk lit a spark for us to try fixing our big ball of mud.</p>

<p>In late 2010 we started to make some changes. Instead of having one giant repository, shared code would be split out
into separate repositories. We also took this opportunity to introduce a new project organization and architecture.</p>

<p>We established one repository to hold utility code, broken into specific class libraries:</p>

<ul>
<li><tt>Fool.Abstractions</tt> - similar in spirit to System.Web.Abstractions; adds interfaces and wrappers to various FCL types that lack them</li>
<li><tt>Fool.Lang</tt> - similar in spirit to <a href="http://commons.apache.org/lang/">Jakarta Commons Lang</a>; adds general utility classes and methods not found elsewhere</li>
<li>Other projects that extend 3rd party class libraries to make them easier for us to work with in standardized ways.</li>
</ul>


<p>Then we established another repository to hold Domain Driven, er, Domains. For example, many of our applications and web sites deal with
stock market data, so one of our business domains is Quotes. In the Quotes Domain we have these projects:</p>

<ul>
<li><tt>Fool.Quotes</tt> - contains service interfaces and value types; serves as an API to the domain</li>
<li><tt>Fool.Quotes.Core</tt> - contains domain logic, models, and entities; serves as a private implementation</li>
<li><tt>Fool.Quotes.Web.Api</tt> - exposes Fool.Quotes interfaces over a RESTful web API</li>
</ul>


<p>The key to keeping our domains distinct and decoupled is to keep Core projects private. While Core is required at runtime,
it should never be referenced at compile time. To bridge the gap, we use Dependency Injection to provide concrete implementations.</p>

<p>Domains may depend on other domains provided that they consume each other through the API project. That way entities and business logic
are kept focused on their own concerns and don&#8217;t leak out to other problem areas where they don&#8217;t fit.</p>

<h2>Gluing It Together</h2>

<p>Having projects split into different repositories and different solutions meant that we couldn&#8217;t simply have one mega Solution
that includes everything. That&#8217;s by design, so good on us. But this introduces a problem in that we still need to reference code
from our utility projects and DDD projects in our applications. The first solution we came up with to handle this problem was
to use the <a href="http://msdn.microsoft.com/en-us/library/wkze6zky.aspx">AssemblyFolders</a> registry to have our libraries
appear in the <tt>Add Reference</tt> dialog. Then to solve the runtime dependency on our private Core assemblies, we install
those to the GAC so they can be loaded using reflection by our IoC container.</p>

<p>This approach worked fine, mostly. But we encountered some downsides after using it for a while:</p>

<ul>
<li>Need to have all library code checked out and built on each development machine</li>
<li>No built-in way to manage different versions of the same dependency</li>
<li><a href="http://www.sellsbrothers.com/Posts/Details/12503">GAC considered harmful</a></li>
<li>Hard to debug build errors and runtime errors</li>
</ul>


<p>Using Continuous Integration means we&#8217;re producing new builds dozens of times a day, so it isn&#8217;t practical for us to
manage different assembly versions for each build. Like most shops, we leave our assembly versions at 1.0.0.0 despite
injecting actual version information into the AssemblyInformationalVersion attribute.</p>

<p>In order to support parallel development, we needed to find a more flexible way of managing dependencies, and
at this point we started to look at binary package management.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/07/26/MSBuild-NuGet-Visual-Studio-Hackery/">MSBuild, Visual Studio & NuGet Hackery</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-07-26T00:00:00-04:00" pubdate data-updated="true">Jul 26<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>My team at work recently switched to using NuGet. We have a fair amount of shared code that used to be in a
monolithic code base with all the problems that came with it. Slow builds, no concept of versions, tight coupling, etc.
To address these issues we started migrating to a new layout where we split Framework Projects out into seperate
repositories and publish NuGet packages for those projects. Then our Application Projects use NuGet to depend on
the Framework Projects and we get better control of when dependencies are upgraded, faster builds and everyone is happy.</p>

<p>One drawback to this migration is that we no longer have all projects in one Visual Studio solution, making it hard to
work on writing a new feature or fixing a bug in a Framework Project and testing that change in an Application Project.
Where we used to be able to do this seemlessly, we now have to jump through some hoops:</p>

<ol>
<li>Change Framework Project</li>
<li>Build Framework Project</li>
<li>Manually copy the dll to the Application Project</li>
<li>Change Application Project to use new code (if necessary)</li>
<li>Build Application Project</li>
</ol>


<p>Once the code changes are deemed acceptable, additional work is necessary to commit/push changes to other developers:</p>

<ol>
<li>Commit/Push Framework Project</li>
<li>Wait for build server to publish a NuGet package</li>
<li>Use NuGet to update Framwork project dependency in Application Project</li>
<li>Commit/Push Application Project</li>
</ol>


<p>This multistep process obviously slows down development significantly. My mission is to find a way to cut out some
of these manual steps so our developers can get back to writing and refactoring code instead of wrestling with tools.</p>

<p><strong> SlimJim </strong></p>

<p>A colleague of mine, Aaron Togerson, started a project a while back called SlimJim.
<a href="https://github.com/AaronTorgerson/SlimJim/commits/master">SlimJim</a> is a Visual Studio Solution Generator.
I&#8217;ve always liked the phrase &#8220;Solution Generator&#8221; despite the fact that Visual Studio solution files have
little to do with solving actual problems.</p>

<p>Anyway, SlimJim is a command-line tool that analyzes c# projects and generates a <code>.sln</code> file
that includes a target project (such as a Framework Project) and all projects that depend on it. This
tool enables us to quickly generate Solutions that allow us to have Framework Projects and Application
projects open in a single instance of Visual Studio. Since SlimJim generates these files pretty quickly,
we never check them into source control.</p>

<p>Using SlimJim in conjunction with ReSharper we gain the ability to navigate through the code and apply
refactoring tools to rename types and methods, change method signatures, introduce parameters, and all
the other fun stuff.</p>

<p><strong> The Pitfall </strong></p>

<p>It&#8217;s great that ReSharper knows how to do this, but the problem is when you hit F6 or click Build Solution,
and you get a bunch of compilation errors. What&#8217;s going on? First, NuGet injects assembly references into
the Application Project instead of injecting project references. Visual Studio uses project references to determine
the build order. So because there is no project reference from Application Project pointing to Framework Project,
the order in which the projects are built will be undefined. The second problem is that even if the build order
could be corrected, there is nothing in place that copies the build output from Framework Project over to
where Application Project will find it.</p>

<p>We could solve both problems by converting the c# project files for Application Projects to replace
&lt;Reference/&gt; items with &lt;ProjectReference/&gt; items. This is how Visual Studio decides what
order projects are built in and how outputs from one project get copied to another.</p>

<p>The problem is that we don&#8217;t want to accidentally commit changes like this. We only want them to apply
to local development. Accidentally checking such changes in will certainly break the build and take us
back to the bad old days of slow builds.</p>

<p><strong> Attempt 1 </strong></p>

<p>To avoid changing c# project files, the first approach I took was to try to do some MSBuild magic and
hope Visual Studio would get in on the game. MSBuild provides some hooks that enable us to manipulate
Item Groups dynamically. First, the <a href="http://msdn.microsoft.com/en-us/library/bcxfsh87.aspx">InitialTargets</a>
attribute can be used to execute some targets before the requested targets are executed. Second, we
can do some analysis of the solution file being built and the project references to try to remove
&lt;Reference/&gt; items and add &lt;ProjectReference/&gt; items dynamically.</p>

<p>Note: this example uses tasks from the <a href="https://github.com/loresoft/msbuildtasks">MSBuild Community Tasks</a> project.</p>

<div><script src='https://gist.github.com/3177148.js?file='></script>
<noscript><pre><code>&lt;Project ToolsVersion=&quot;4.0&quot; InitialTargets=&quot;_ReplaceReferencesWithProjectReferences&quot; xmlns=&quot;http://schemas.microsoft.com/developer/msbuild/2003&quot;&gt;
    
    &lt;Target Name=&quot;_ReplaceReferencesWithProjectReferences&quot; DependsOnTargets=&quot;Part1;Part2;Part3;Part4&quot; Condition=&quot; Exists('$(SolutionPath)') and '$(BuildingInsideVisualStudio)' == 'True' &quot;/&gt;
    
    &lt;Target Name=&quot;Part1&quot;&gt;
        &lt;GetSolutionProjects Solution=&quot;$(SolutionPath)&quot;&gt;
            &lt;Output TaskParameter=&quot;Output&quot; ItemName=&quot;_SolutionProject&quot;/&gt;
        &lt;/GetSolutionProjects&gt;
        
        &lt;RemoveDuplicates Inputs=&quot;@(_SolutionProject)&quot;&gt;
            &lt;Output TaskParameter=&quot;Filtered&quot; ItemName=&quot;_SolutionProjectUnique&quot;/&gt;
        &lt;/RemoveDuplicates&gt;
        
        &lt;ItemGroup&gt;
            &lt;_SolutionProject Remove=&quot;@(_SolutionProject)&quot;/&gt;
        &lt;/ItemGroup&gt;
    &lt;/Target&gt;
    
    &lt;Target Name=&quot;Part2&quot; Inputs=&quot;%(_SolutionProjectUnique.Identity)&quot; Outputs=&quot;**none**&quot;&gt;
        &lt;XmlRead
            XmlFileName=&quot;@(_SolutionProjectUnique)&quot;
            XPath=&quot;/msb:Project/msb:PropertyGroup/msb:AssemblyName/text()&quot;
            Prefix=&quot;msb&quot; Namespace=&quot;http://schemas.microsoft.com/developer/msbuild/2003&quot;&gt;
            &lt;Output PropertyName=&quot;_SolutionProjectAssemblyName&quot; TaskParameter=&quot;Value&quot;/&gt;
        &lt;/XmlRead&gt;
        &lt;XmlRead
            XmlFileName=&quot;@(_SolutionProjectUnique)&quot;
            XPath=&quot;/msb:Project/msb:PropertyGroup/msb:ProjectGuid/text()&quot;
            Prefix=&quot;msb&quot; Namespace=&quot;http://schemas.microsoft.com/developer/msbuild/2003&quot;&gt;
            &lt;Output PropertyName=&quot;_SolutionProjectGuid&quot; TaskParameter=&quot;Value&quot;/&gt;
        &lt;/XmlRead&gt;
        
        &lt;ItemGroup&gt;
            &lt;_SolutionProject Include=&quot;@(_SolutionProjectUnique)&quot;&gt;
                &lt;Project&gt;$(_SolutionProjectGuid)&lt;/Project&gt;
                &lt;Name&gt;$(_SolutionProjectAssemblyName)&lt;/Name&gt;
            &lt;/_SolutionProject&gt;
        &lt;/ItemGroup&gt;
    &lt;/Target&gt;
    
    &lt;Target Name=&quot;Part3&quot;&gt;
        &lt;ItemGroup&gt;
            &lt;_ReferenceWithHintPath Include=&quot;@(Reference)&quot; Condition=&quot;%(Reference.HintPath) != ''&quot;/&gt;
        &lt;/ItemGroup&gt;
            
        &lt;ItemGroup&gt;
            &lt;_ReferenceWithProjectName Include=&quot;@(_ReferenceWithHintPath)&quot;&gt;
                &lt;Name&gt;$([System.IO.Path]::GetFileNameWithoutExtension('%(HintPath)'))&lt;/Name&gt;
            &lt;/_ReferenceWithProjectName&gt;
        &lt;/ItemGroup&gt;
        
        &lt;ItemGroup&gt;
            &lt;_ReferenceToRemove Include=&quot;@(_ReferenceWithProjectName)&quot; Condition=&quot; %(Name) != '' and @(_ReferenceWithProjectName) != '' and @(_SolutionProject) != '' &quot;/&gt;
        &lt;/ItemGroup&gt;
        
        &lt;ItemGroup&gt;
            &lt;_ProjectReferenceToAdd Include=&quot;@(_SolutionProject)&quot; Condition=&quot; %(Name) != '' and @(_ReferenceWithProjectName) != '' and @(_SolutionProject) != '' &quot;/&gt;
        &lt;/ItemGroup&gt;
        
        &lt;Message Text=&quot;Remove Reference: %(_ReferenceToRemove.Identity)&quot;/&gt;
        &lt;Message Text=&quot;Add ProjectReference: %(_ProjectReferenceToAdd.Identity) Project %(_ProjectReferenceToAdd.Project) Name %(_ProjectReferenceToAdd.Name)&quot;/&gt;
    &lt;/Target&gt;
    
    &lt;Target Name=&quot;Part4&quot;&gt;
        &lt;ItemGroup&gt;
            &lt;Reference Remove=&quot;@(ReferenceToReplace)&quot;/&gt;
        &lt;/ItemGroup&gt;
        
        &lt;ItemGroup&gt;
            &lt;ProjectReference Include=&quot;@(_ProjectReferenceToAdd)&quot;/&gt;
        &lt;/ItemGroup&gt;
    &lt;/Target&gt;
&lt;/Project&gt;</code></pre></noscript></div>


<p>This implementation works great in MSBuild on the command line when invoked on a c# project.
If you specify a SolutionPath and BuildingInsideVisualStudio,
MSBuild will faithfully build the Framework Projects before building the Application Project.</p>

<p>However, it doesn&#8217;t work in Visual Studio. Evidently when Visual Studio loads a solution, it
either doesn&#8217;t execute InitialTargets or it uses some other mechanism to extract &lt;ProjectReference/&gt;
items from each project.</p>

<p><strong> Attempt 2 </strong></p>

<p>If we can&#8217;t dynamically tell Visual Studio about project references, I thought maybe we could just build
the projects in the right order ourselves. MSBuild already does this when building outside Visual Studio
provided the BuildProjectReferences property is not false.</p>

<p>So I modified my MSBuild script to try to do that:</p>

<div><script src='https://gist.github.com/3177381.js?file='></script>
<noscript><pre><code>&lt;Project InitialTargets=&quot;_FindDependentSolutionProjects&quot; ToolsVersion=&quot;4.0&quot; xmlns=&quot;http://schemas.microsoft.com/developer/msbuild/2003&quot;&gt;
    &lt;PropertyGroup&gt;
        &lt;BuildDependsOn&gt;
            BuildDependentSolutionProjects;
            $(BuildDependsOn)
        &lt;/BuildDependsOn&gt;
    &lt;/PropertyGroup&gt;
    
    &lt;Target Name=&quot;BuildDependentSolutionProjects&quot; Condition=&quot; '@(_ProjectReference)' != '' &quot;&gt;
        &lt;Message Text=&quot;$(MSBuildProjectName) is building @(_ProjectReference)&quot; Importance=&quot;High&quot;/&gt;
        &lt;MSBuild
            Projects=&quot;@(_ProjectReference)&quot;
            Targets=&quot;Build&quot;
            BuildInParallel=&quot;false&quot;
            Condition=&quot; '$(BuildProjectReferences)' != 'false' &quot;
            Properties=&quot;UseHostCompilerIfAvailable=false&quot;/&gt;
    &lt;/Target&gt;
    
    &lt;Target Name=&quot;_FindDependentSolutionProjects&quot; DependsOnTargets=&quot;Part1;Part2;Part3&quot; Condition=&quot; Exists('$(SolutionPath)') and '$(BuildingInsideVisualStudio)' == 'True' &quot;/&gt;
    
    &lt;Target Name=&quot;Part1&quot;&gt;
        &lt;GetSolutionProjects Solution=&quot;$(SolutionPath)&quot;&gt;
            &lt;Output TaskParameter=&quot;Output&quot; ItemName=&quot;_SolutionProject&quot;/&gt;
        &lt;/GetSolutionProjects&gt;
        
        &lt;RemoveDuplicates Inputs=&quot;@(_SolutionProject)&quot;&gt;
            &lt;Output TaskParameter=&quot;Filtered&quot; ItemName=&quot;_SolutionProjectUnique&quot;/&gt;
        &lt;/RemoveDuplicates&gt;
        
        &lt;ItemGroup&gt;
            &lt;_SolutionProject Remove=&quot;@(_SolutionProject)&quot;/&gt;
        &lt;/ItemGroup&gt;
    &lt;/Target&gt;
    
    &lt;Target Name=&quot;Part2&quot; Inputs=&quot;%(_SolutionProjectUnique.Identity)&quot; Outputs=&quot;**none**&quot;&gt;
        &lt;XmlRead
            XmlFileName=&quot;@(_SolutionProjectUnique)&quot;
            XPath=&quot;/msb:Project/msb:PropertyGroup/msb:AssemblyName/text()&quot;
            Prefix=&quot;msb&quot; Namespace=&quot;http://schemas.microsoft.com/developer/msbuild/2003&quot;&gt;
            &lt;Output PropertyName=&quot;_SolutionProjectAssemblyName&quot; TaskParameter=&quot;Value&quot;/&gt;
        &lt;/XmlRead&gt;
        &lt;XmlRead
            XmlFileName=&quot;@(_SolutionProjectUnique)&quot;
            XPath=&quot;/msb:Project/msb:PropertyGroup/msb:ProjectGuid/text()&quot;
            Prefix=&quot;msb&quot; Namespace=&quot;http://schemas.microsoft.com/developer/msbuild/2003&quot;&gt;
            &lt;Output PropertyName=&quot;_SolutionProjectGuid&quot; TaskParameter=&quot;Value&quot;/&gt;
        &lt;/XmlRead&gt;
        
        &lt;ItemGroup&gt;
            &lt;_SolutionProject Include=&quot;@(_SolutionProjectUnique)&quot;&gt;
                &lt;Project&gt;$(_SolutionProjectGuid)&lt;/Project&gt;
                &lt;Name&gt;$(_SolutionProjectAssemblyName)&lt;/Name&gt;
            &lt;/_SolutionProject&gt;
        &lt;/ItemGroup&gt;
    &lt;/Target&gt;
    
    &lt;Target Name=&quot;Part3&quot;&gt;
        &lt;ItemGroup&gt;
            &lt;_ReferenceWithHintPath Include=&quot;@(Reference)&quot; Condition=&quot;%(Reference.HintPath) != ''&quot;/&gt;
        &lt;/ItemGroup&gt;
            
        &lt;ItemGroup&gt;
            &lt;_ReferenceWithProjectName Include=&quot;@(_ReferenceWithHintPath)&quot;&gt;
                &lt;Name&gt;$([System.IO.Path]::GetFileNameWithoutExtension('%(HintPath)'))&lt;/Name&gt;
            &lt;/_ReferenceWithProjectName&gt;
        &lt;/ItemGroup&gt;
        
        &lt;ItemGroup&gt;
            &lt;_ProjectReference Include=&quot;@(_SolutionProject)&quot; Condition=&quot; %(Name) != '' and @(_ReferenceWithProjectName) != '' and @(_SolutionProject) != '' &quot;/&gt;
        &lt;/ItemGroup&gt;
        
        &lt;Message Text=&quot;Detected ProjectReference: %(_ProjectReference.Identity) Project %(_ProjectReference.Project) Name %(_ProjectReference.Name)&quot;/&gt;
    &lt;/Target&gt;
&lt;/Project&gt;</code></pre></noscript></div>


<p>Once again, this works great in MSBuild outside of Visual Studio. When you load up the solution in VS
and hit build, the Output pane says encouraging things like &#8220;MyApp is building C:\Projects\MyFramework\src\MyFramework\MyFramework.csproj&#8221;.</p>

<p>Except it doesn&#8217;t. I couldn&#8217;t figure out why, but somehow Visual Studio seems to know that we&#8217;re trying to trick it, and it refuses
to actually build the project. It pretends to, but it doesn&#8217;t. I thought this might have to do with In-Process Compilers and
other optimizations described in the <a href="http://msdn.microsoft.com/en-us/library/ms171468.aspx">Visual Studio MSBuild Integration</a> article,
but attempting to disable <code>UseHostCompilerIfAvailable</code> has no effect.</p>

<p>I gave up on this strategy becuase even if it helped to build projects in the right order, it doesn&#8217;t copy build outputs from one
project to the other.</p>

<p><strong> Attempt 3 </strong></p>

<p>Once again, Visual Studio proved to be too enterprisey for us to customize. The only proof of concept I was able to make work
was the dumb one: converting c# projects and risking that the converted versions get checked in. We can solve the accidental commit
issue with a pre-commit hook, so maybe it isn&#8217;t all bad as long as we can seemlessly convert back and forth.</p>

<p>Since we already have a tool that analyzes c# project references, it makes sense to extend SlimJim to mangle c# projects while analyzing them.</p>

<p>My <a href="https://github.com/chriseldredge/SlimJim">fork</a> of SlimJim now includes two new switches: <code>--convert</code> and <code>--unconvert</code>.</p>

<p>Suppose SlimJim finds two projects, MyApp and MyFramework, and MyApp.csproj looks like this:</p>

<figure class='code'><figcaption><span>MyApp.csproj</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;Project</span> <span class="na">ToolsVersion=</span><span class="s">&quot;4.0&quot;</span> <span class="na">DefaultTargets=</span><span class="s">&quot;Build&quot;</span> <span class="na">xmlns=</span><span class="s">&quot;http://schemas.microsoft.com/developer/msbuild/2003&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;ItemGroup&gt;</span>
</span><span class='line'>    <span class="nt">&lt;Reference</span> <span class="na">Include=</span><span class="s">&quot;MyFramework, Version=1.0.0.0, Culture=neutral, PublicKeyToken=3c369c070579152a, processorArchitecture=MSIL&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;HintPath&gt;</span>..\packages\MyFramework\lib\net40\MyFramework.dll<span class="nt">&lt;/HintPath&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/Reference&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/ItemGroup&gt;</span>
</span><span class='line'><span class="nt">&lt;/Project&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Using <code>--convert</code>, SlimJim will change MyApp.csproj to look like this:</p>

<figure class='code'><figcaption><span>MyApp.csproj after SlimJim</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;Project</span> <span class="na">ToolsVersion=</span><span class="s">&quot;4.0&quot;</span> <span class="na">DefaultTargets=</span><span class="s">&quot;Build&quot;</span> <span class="na">xmlns=</span><span class="s">&quot;http://schemas.microsoft.com/developer/msbuild/2003&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;ItemGroup&gt;</span>
</span><span class='line'>    <span class="nt">&lt;ProjectReference</span> <span class="na">Include=</span><span class="s">&quot;C:\projects\MyFramework\src\MyFramework\MyFramework.csproj&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;Project&gt;</span>{673A97DA-4302-48C9-BFF0-A57FD7DBA93F}<span class="nt">&lt;/Project&gt;</span>
</span><span class='line'>      <span class="nt">&lt;Name&gt;</span>MyFramework<span class="nt">&lt;/Name&gt;</span>
</span><span class='line'>      <span class="nt">&lt;SlimJimReplacedReference&gt;</span>
</span><span class='line'>        <span class="nt">&lt;Reference</span> <span class="na">Include=</span><span class="s">&quot;MyFramework, Version=1.0.0.0, Culture=neutral, PublicKeyToken=3c369c070579152a, processorArchitecture=MSIL&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>          <span class="nt">&lt;HintPath&gt;</span>..\packages\MyFramework\lib\net40\MyFramework.dll<span class="nt">&lt;/HintPath&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/Reference&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/SlimJimReplacedReference&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/ProjectReference&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/ItemGroup&gt;</span>
</span><span class='line'><span class="nt">&lt;/Project&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>And using <code>--uncovert</code> will put it back. The original assembly reference is preserved in the markup, moved out of the
way so MSBuild and Visual Studio will ignore it, but making it easy for us to restore it without losing metadata like HintPath
and SpecificVersion.</p>

<p>As long as we remember to <code>--unconvert</code> before committing, this new feature should provide a great benefit.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/07/24/Unit-of-Work-and-Eventual-Consistency/">Unit of Work & Eventual Consistency</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-07-24T00:00:00-04:00" pubdate data-updated="true">Jul 24<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><em>Lucene.Net.Linq is available on the NuGet Gallery at <a href="http://nuget.org/packages/Lucene.Net.Linq">http://nuget.org/packages/Lucene.Net.Linq</a>.</em></p>

<p>Recent versions of Lucene.Net.Linq added support for the <a href="http://martinfowler.com/eaaCatalog/unitOfWork.html">Unit of Work</a> pattern.</p>

<p>The standard Unit of Work has methods like <code>registerNew</code> and <code>registerDeleted</code>, but I decided to use more generic
names that make the interface appear more like a simple collection of documents.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">interface</span> <span class="n">ISession</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">IDisposable</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">IQueryable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">Query</span><span class="p">();</span>
</span><span class='line'>  <span class="k">void</span> <span class="nf">Add</span><span class="p">(</span><span class="k">params</span> <span class="n">T</span><span class="p">[]</span> <span class="n">items</span><span class="p">);</span>
</span><span class='line'>  <span class="k">void</span> <span class="nf">Delete</span><span class="p">(</span><span class="k">params</span> <span class="n">T</span><span class="p">[]</span> <span class="n">items</span><span class="p">);</span>
</span><span class='line'>  <span class="k">void</span> <span class="nf">Delete</span><span class="p">(</span><span class="k">params</span> <span class="n">Query</span><span class="p">[]</span> <span class="n">items</span><span class="p">);</span>
</span><span class='line'>  <span class="k">void</span> <span class="nf">DeleteAll</span><span class="p">();</span>
</span><span class='line'>  <span class="k">void</span> <span class="nf">Commit</span><span class="p">();</span>
</span><span class='line'>  <span class="k">void</span> <span class="nf">Rollback</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>Delete</code> method that takes one or more <code>Query</code> objects is a case special to Lucene.Net. This is an escape hatch
for when you want to delete one or more documents without first retrieving them. For example, you may want to delete all documents that
match a query like <code>type:person</code>. I have mixed feelings about this escape hatch, because it smells like a
<a href="http://c2.com/cgi/wiki?LeakyAbstraction">Leaky Abstraction</a>. On the other hand, since it is an overload to a more abstract method,
I think it makes sense from a performance standpoint.</p>

<p>Anyway, one notable method pair is missing from the interface: <code>registerDirty</code> and <code>registerClean</code>. That&#8217;s because
the session does some book keeping behind the scenes to automatically detect dirty documents when the session is committed.</p>

<p>This makes using Lucene.Net.Linq as a <a href="http://martinfowler.com/eaaCatalog/repository.html">Repository</a> dead simple, and makes the code
look nice and clean in the client:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">void</span> <span class="nf">ChangeMailingAddress</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">,</span> <span class="kt">string</span> <span class="n">newAddress</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">session</span> <span class="p">=</span> <span class="n">provider</span><span class="p">.</span><span class="n">OpenSession</span><span class="p">&lt;</span><span class="n">SampleDocument</span><span class="p">&gt;();</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">using</span> <span class="p">(</span><span class="n">session</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="kt">var</span> <span class="n">person</span> <span class="p">=</span> <span class="n">session</span><span class="p">.</span><span class="n">Query</span><span class="p">().</span><span class="n">Single</span><span class="p">(</span><span class="n">p</span> <span class="p">=&gt;</span> <span class="n">p</span><span class="p">.</span><span class="n">Name</span> <span class="p">==</span> <span class="n">name</span><span class="p">);</span>
</span><span class='line'>      <span class="n">person</span><span class="p">.</span><span class="n">MailingAddress</span> <span class="p">=</span> <span class="n">newAddress</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Document Tracking</h2>

<p>So how does it work?</p>

<p>When you ask for an IQueryable from session, the session attaches an instance of IRetrievedDocumentTracker to the queryable before
returning it. That internal interface has only one method call:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">void</span> <span class="nf">TrackDocument</span><span class="p">(</span><span class="n">T</span> <span class="n">item</span><span class="p">,</span> <span class="n">T</span> <span class="n">hiddenCopy</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>When the LuceneQueryExecutor starts returning results one item at a time, if it detects that a document tracker has been attached,
it makes two copies of each result. One is returned to the client and the other is passed only to the tracker as a hidden copy.
This gives the library the ability to compare pristine objects that came from the index unmodified with ones that may have been
modified with the client.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">for</span> <span class="p">(</span><span class="kt">var</span> <span class="n">i</span> <span class="p">=</span> <span class="n">skipResults</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">hits</span><span class="p">.</span><span class="n">ScoreDocs</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">var</span> <span class="n">doc</span> <span class="p">=</span> <span class="n">hits</span><span class="p">.</span><span class="n">ScoreDocs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">doc</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">var</span> <span class="n">score</span> <span class="p">=</span> <span class="n">hits</span><span class="p">.</span><span class="n">ScoreDocs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">score</span><span class="p">;</span>
</span><span class='line'>  
</span><span class='line'>  <span class="kt">var</span> <span class="n">item</span> <span class="p">=</span> <span class="n">ConvertDocument</span><span class="p">(</span><span class="n">searcher</span><span class="p">.</span><span class="n">Doc</span><span class="p">(</span><span class="n">doc</span><span class="p">),</span> <span class="n">score</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">tracker</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="kt">var</span> <span class="n">copy</span> <span class="p">=</span> <span class="n">ConvertDocument</span><span class="p">(</span><span class="n">searcher</span><span class="p">.</span><span class="n">Doc</span><span class="p">(</span><span class="n">doc</span><span class="p">),</span> <span class="n">score</span><span class="p">);</span>
</span><span class='line'>      <span class="n">tracker</span><span class="p">.</span><span class="n">TrackDocument</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">copy</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">itemHolder</span><span class="p">.</span><span class="n">Current</span> <span class="p">=</span> <span class="n">item</span><span class="p">;</span>
</span><span class='line'>  <span class="k">yield</span> <span class="k">return</span> <span class="nf">projector</span><span class="p">(</span><span class="n">itemHolder</span><span class="p">.</span><span class="n">Current</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally, when the session is committed, all tracked documents are compared with their hidden copies (using reflection) to detect
which documents were modified. Modified documents are written back to the index.</p>

<h2>Eventual Consistency</h2>

<p>The concepts of eventual consitency describe what expectations a client may have about the ordering and visibility of writes in
a distributed asynchronous persistence system. Werner Vogels has written about different
<a href="http://www.allthingsdistributed.com/2008/12/eventually_consistent.html">consistency definitions</a>.</p>

<p>Since the unit of work in Lucene.Net.Linq is implemented by an interface named ISession, it would have been nice to provide
Session Consistency. It&#8217;s open to some interpretation if this behavior is achieved or not. Since the underlying Lucene engine
will not make changes visible to an IndexReader until a commit happens and the IndexReader is reopened, it is difficult or
impossible to allow a client to see the effects of adding, deleting or modifying a document in subsequent queries within the same
session. However, this problem can be side-stepped by simply calling <code>Commit</code> between making changes and subsequent queries.
Calling <code>Commit</code> explicitly may have drawbacks if the client will make further changes and wishes for those changes to
appear atomically. Knowing the details of when staged changes become visible will help clients to make changes smartly.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/07/03/Speeding-Up-NuGet-Server/">Speeding Up NuGet.Server</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-07-03T00:00:00-04:00" pubdate data-updated="true">Jul 3<span>rd</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><em>(Get the source code at <a href="https://github.com/themotleyfool/NuGet">https://github.com/themotleyfool/NuGet</a>)</em></p>

<p>Last time I wrote about creating a LINQ provider for Lucene.Net, and today I&#8217;ll talk about integrating that provider
with NuGet. The existing server part of the NuGet codebase is a drop-in replacement for using local file-system based
feeds. I wanted to try to preserve that turnkey advantage but improve the performance of various queries.</p>

<p>In order to make sure that my improvements were up to snuff, I set up a private mirror of all packages on <a href="http://nuget.org/">nuget.org</a>,
which turned out to be 44,193 packages at the time, for a total size of over 20 gigs.</p>

<p>If you try hitting ~/api/v2/Packages on stock NuGet.Server, you&#8217;ll find that your request just spins and spins. And spins. In fact
it took so long that I gave up waiting for the application to initialize. In the background, the server is finding all <code>*.nupkg</code>
files in ~/Packages and calculating a hash of the contents. Needless to say, it can take a while to run a checksum algorithm on 20gb
of data.</p>

<p>Switching over to my custom lucene branch, the first time the site is started, it scans the Packages folder and finds all packages
that haven&#8217;t been indexed by Lucene. The site homepage helpfully tells you the current status, such as &#8220;Indexing 2113 of 44193 new packages.&#8221;
An ajax timer refreshes the info every few seconds so progress can be easily tracked.</p>

<p>The packages don&#8217;t begin to appear in the feed until they&#8217;ve all been indexed. So this isn&#8217;t much better than stock NuGet.Server.</p>

<h2>Incremental Indexing</h2>

<p>The real improvements are appreciated after the initial index is built.</p>

<pre><code>[celdredge@localhost]$ appcmd recycle apppool nuget
"nuget" successfully recycled

[celdredge@localhost]$ time wget -O /dev/null http://localhost/api/v2/Packages

(snip)

real    0m3.230s
user    0m0.062s
sys     0m0.125s
</code></pre>

<p>This means that you don&#8217;t have to worry much about IIS shutting down the application during idle times. The index gets loaded and ready to go
in a matter of seconds. Vast improvement over stock NuGet.Server.</p>

<p>While that happens, a background thread scans the Packages folder to see what might have changed while the application was stopped. New, modified
and deleted packages are synchronized with the Lucene index. The sycnhronization process takes about 25 seconds to scan 44,193 package files
split into 6,180 folders and calculate the differences with the Lucene index. That&#8217;s pretty fast.</p>

<p>After the application finishes this initial scan, a FileSystemWatcher monitors the Packages folder to synchronize any changes in real time.
This allows the index to stay in sync when new packages appear, even if they are copied into the folder instead of using <code>nuget push</code>.</p>

<h2>Superfast Search</h2>

<p>All sorts of complex queries are possible, and they execute in very reasonable time. I used <a href="http://www.linqpad.net/">LINQPad</a> to
construct various test queries, like this one that finds packages whose id contain lucene but do not start with lucene:</p>

<pre><code>from p in Packages
where p.Id.Contains("Lucene")
where !p.Id.StartsWith("Lucene")
where p.IsLatestVersion
orderby p.Id descending
select p

Query successful (00:00.136)
</code></pre>

<p>136ms is pretty respectable, IMO.</p>

<p>Another advantage to using Lucene is how queries are analyzed. Term queries will match various word forms, so a query like <tt>build</tt> will
match packages that use any words like build, builds, building, built, etc. It is also possible to search for phrase queries, such as
<tt>&#8220;glue them back together&#8221;</tt>. That query matches only one package that contains the exact phrase, whereas on nuget.org you&#8217;ll get
all kinds of results.</p>

<h2>Other Features</h2>

<p>The <a href="https://github.com/NuGet/NuGetGallery/wiki/Tab-Completion-API-Endpoints">Tab Completion API Endpoints</a> introduced in NuGet 2.0 have
been implemented, bringing fast results to users of the Package Manager Console.</p>

<h2>Conclusion</h2>

<p>It has taken a substantial amount of time and effort to implement Lucene.Net.Linq and integrate it with NuGet.Server, but the results
have proven to be worth the investment.</p>

<p>Lucene.Net.Linq has become a fairly mature, though still nascent, project now available on <a href="http://nuget.org/packages/Lucene.Net.Linq">nuget.org</a>. There are a few other
OSS projects that attempt to do what it does, but I think it is already one of the best.</p>

<p>Binaries of NuGet.Server + Lucene can be downloaded from <a href="https://github.com/themotleyfool/NuGet/downloads">https://github.com/themotleyfool/NuGet/downloads</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/05/08/Introducing-Linq-to-Lucene/">Introducing LINQ to Lucene</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-05-08T00:00:00-04:00" pubdate data-updated="true">May 8<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><em>(Get the source code at <a href="https://github.com/themotleyfool/Lucene.Net.Linq">https://github.com/themotleyfool/Lucene.Net.Linq</a>)</em></p>

<p>For the last several weeks I&#8217;ve been working with <a href="http://octopusdeploy.com/">OctopusDeploy</a>, a new one-click deployment
system for .net applications and websites. The way you get your software into Octopus is by publishing packages to
a <a href="http://nuget.org/">NuGet</a> feed. Octopus will monitor the feed, grab your package, send it out to the servers that will
host your software, then instruct the servers to unzip the package and run your deployment scripts.</p>

<p>We&#8217;re pretty happy with Octopus, but we ran into a problem with our NuGet feed. Since we use continuous integration, we
produce 10 or 20 builds a day and each one of those successful builds becomes a release candidate that we want to be
available in Octopus. We found that as we published more packages to our internal feed, the slower Octopus became when
accessing it. It doesn&#8217;t help that some of our packages are 40mb websites.</p>

<p>Thinking that the stateless nature of a file-based NuGet feed might be the culprit, we switched over to
<a href="https://nuget.org/packages/NuGet.Server">NuGet.Server</a>, an asp.net web app that provides access to NuGet packages over http.
As it turns out, NuGet.Server isn&#8217;t significantly better at handling lots of packages or even a handful of rather large packages.</p>

<p>The reason is because NuGet.Server doesn&#8217;t actually cache much information about packages, so each time a client executes a query,
the server has to:</p>

<ul>
<li>Enumerate all <code>*.nupkg</code> files on the file system</li>
<li>Open the zip file and

<ul>
<li>Seek to the nuspec metadata entry</li>
<li>Parse the entry</li>
</ul>
</li>
<li>Obtain file metadata (last modified date, size)</li>
<li>Calculate a checksum hash of the file contents (bigger package, slower hash time)</li>
</ul>


<p>One thing NuGet.Server does that a file-based feed does not is cache some of this metadata (like the hash code), but this
is an in-memory cache, meaning that when the web app restarts or is shutdown after an idle period, the entire cache goes away.</p>

<p>Even with the cache, operations like finding the latest version of a package or sorting packages by name are much slower than
they could be. Not to mention, the &#8220;search&#8221; functionality leaves something to be desired.</p>

<h2>Hooray for Open Source</h2>

<p>I set out to make NuGet.Server faster and I wanted to do it with something light weight. Something that can index and search,
but doesn&#8217;t require a database and all the complexity that comes with it. If I wanted all that I could have just used
<a href="https://github.com/NuGet/NuGetGallery">NuGet Gallery</a>.</p>

<p>I decided to use <a href="http://incubator.apache.org/lucene.net/">Lucene.Net</a> as my data source, but looking at the existing NuGet code,
I realized that NuGet uses <a href="http://www.odata.org">OData</a> to expose a queryable data source over the web. That sounds nice and all,
but in the server side in asp.net, that basically means you need an implementation of <code>IQueryable&lt;T&gt;</code>. Those can
be hard to come by.</p>

<h2>Boo for OData, LINQ and IQueryable</h2>

<p>Exposing a search/query interface over the web powered by Lucene is not hard to do. Exposing an OData compatible endpoint powered
by Lucene is so insanely complicated that I have to conclude that OData is a cruel joke for anyone not using Entity Framework (and
if you are using EF, the joke was already on you).</p>

<p>OData sounds great in that the types of queries a client can construct are limitless. But in practice, NuGet does not need this
insane amount of power. Really all that is needed is a simple interface that lets you enumerate packages in some pre-defined
ways.</p>

<p>But since NuGet has a large install base that is using OData, it was time to try to connect <code>IQueryable&lt;T&gt;</code> with Lucene.</p>

<p>There is already a <a href="http://linqtolucene.codeplex.com/">LINQ to Lucene</a> project on CodePlex, but after working with it I found that
it does not support enough of the LINQ expressions to work seamlessly with OData.</p>

<p>So I decided to try and write my own.</p>

<h2>Introducing Lucene.Net.Linq</h2>

<p><a href="https://github.com/themotleyfool/Lucene.Net.Linq">Lucene.Net.Linq</a> is the result of my quest to make NuGet.Server faster.
The library is incomplete and the features it does support were motivated by making it compatible enough with OData in general
and NuGet.Server in particular.</p>

<p>This project turned out to be even more needlessly complex due to the way Microsoft&#8217;s WCF Data Services <a href="http://msdn.microsoft.com/en-us/library/dd723653.aspx">Reflection Provider</a>
tries to avoid <code>NullReferenceException</code> by turning simple queries into completely insane ones. This is a problem that the
NuGet Gallery folks also <a href="http://blog.davidebbo.com/2011/08/how-odata-quirk-killed-nuget-server.html">ran into</a>.</p>

<p>So a large part of Lucene.Net.Linq jumps through hoops because the Reflection Provider takes a simple OData query like:</p>

<pre>
Packages()?$filter=startswith(Id,'foo')
</pre>


<p>And turns it into a complex query like:</p>

<pre>
IIF(
  (IIF(([package].Id == null), null, Convert([package].Id.StartsWith("r"))) == null),
   False,
   Convert(IIF(([package].Id == null), null, Convert([package].Id.StartsWith("foo")))))
</pre>


<p>And hands that off to the poor IQueryable implementor to make sense of. At the end of the
day this query ends up being converted to a Lucene PrefixQuery such as:</p>

<pre>
Id:foo*
</pre>


<p>All of this could have been avoided if the WCF Data Services <a href="http://msdn.microsoft.com/en-us/library/dd723653.aspx">Reflection Provider</a>
would let clients set <a href="http://msdn.microsoft.com/en-us/library/system.data.services.providers.idataservicequeryprovider.isnullpropagationrequired.aspx">IsNullPropagationRequired</a>
to <code>false</code>.</p>

<h2>Conclusion</h2>

<p><a href="https://github.com/themotleyfool/Lucene.Net.Linq">Lucene.Net.Linq</a> was written for a very specific purpose,
but it could be generally useful for plugging Lucene into
places that already use LINQ to execute queries and to expose Lucene indexes over OData (but don&#8217;t use OData; you&#8217;re better than that).</p>

<p>We hope you find it useful!</p>

<p>To comply with the different licenses of Lucene.Net and <a href="http://relinq.codeplex.com/">re-linq</a>, the library is co-licensed under the
terms of the <a href="http://www.gnu.org/licenses/lgpl-2.1-standalone.html">LGPL</a>
and <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License</a>.</p>

<p>Look for this library at NuGet.org soon!</p>

<p>Get the source code at <a href="https://github.com/themotleyfool/Lucene.Net.Linq">https://github.com/themotleyfool/Lucene.Net.Linq</a>.</p>

<p>Up next: releasing a blazingly fast NuGet feed.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/04/19/Lucene-NumericField-Gotcha/">Lucene NumericField Gotcha</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-19T00:00:00-04:00" pubdate data-updated="true">Apr 19<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Today I ran into an interesting problem using
<a href="https://svn.apache.org/repos/asf/incubator/lucene.net/trunk/src/core/Document/NumericField.cs">NumericField</a>.</p>

<p>The issue is that when a document is retrieved, fields encoded using NumericField come back as plain old
strings.  This isn&#8217;t a problem by itself, but if you retrieve a document, modify some fields and leave
others alone, any unmodified field that was previously a NumericField reverts to a basic string value.</p>

<p>The issue is demonstrated by this sample NUnit test fixture:</p>

<script src="https://gist.github.com/2425347.js"> </script>


<p>Long story short, if your documents are going to take round trips and get re-indexed, you must re-encode
any NumericFields before adding the document back to the index, even if they did not change.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/03/29/Getting-Started-With-Relinq/">Getting Started With Re-linq</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-03-29T00:00:00-04:00" pubdate data-updated="true">Mar 29<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>The IQueryable Conundrum</h2>

<p>So, you have a datasource you can access from .net and you thought, hey wouldn&#8217;t it be
cool if I could wire this up with LINQ?</p>

<p>Maybe you&#8217;ve read about how <a href="http://blog.ploeh.dk/2012/03/26/IQueryableIsTightCoupling.aspx">IQueryable is Tight Coupling</a>,
but you figure that you&#8217;re connecting up a low-level datasource and you&#8217;ll probably encapsulate the messy IQueryable stuff
in your domain. So you forge ahead.</p>

<p>You create a class that implements IQueryable, maybe using
<a href="http://msdn.microsoft.com/en-us/library/bb546158.aspx">Walkthrough: Creating an IQueryable LINQ Provider</a>
as a starting point.</p>

<p>Now you&#8217;re left with an Expression object and you get to figure out what to do with it. Sure, you
can use reflection like the MSDN example demonstrates, but some lingering doubt enters in when you
realize how complex even the most basic statements will be to parse.</p>

<p>Then maybe you find a new resource: <a href="http://blogs.msdn.com/b/mattwar/archive/2008/11/18/linq-links.aspx">LINQ: Building an IQueryable provider series</a>
and you think, hey, only 17 massive posts to trudge through.</p>

<p>Ok, so this is no work for the weary. No wonder we don&#8217;t have scads of LINQ providers floating around on codeplex.com and codeproject.com.</p>

<h2>Enter re-linq</h2>

<p><a href="http://relinq.codeplex.com/">re-linq</a> is an open source project that attempts to ease the burden of implementing IQueryable.</p>

<p>It seems like a great project that should help you write less code, but there&#8217;s just one problem: re-linq has zero documentation.</p>

<p>Their project page links to the tantalizingly friendly example <a href="http://www.codeproject.com/Articles/42059/re-linq-ishing-the-Pain-Using-re-linq-to-Implement">re-linq|ishing the Pain: Using re-linq to Implement a Powerful LINQ Provider on the Example of NHibernate</a>,
but after you download the code you realize soon enough that the project is outdated and doesn&#8217;t even compile against re-linq 1.13.</p>

<p>Alas, you have one demo project to go on as supplied in the re-linq source bundle: Linq.LinqToSqlAppender. Needlesstosay,
this project is arguably more complex than the actual support library it builds on. For someone trying to get started, looking
at a provider that generates SQL queries is probably a little too complex of a starting point.</p>

<h2>The Bare Bones</h2>

<p>Submitted for your entertainment, here lies the recipe for the most basic shell you can use to build upon re-linq.</p>

<p>First, create a new c# project.  Then using Nuget or going on your own, grab a copy of Remotion.Linq
(In the Package Manager Coneole, type <tt>Install-Package Remotion.Linq</tt>)</p>

<p>One you have your project ready, here&#8217;s your code:</p>

<script src="https://gist.github.com/2246429.js"> </script>


<p>This implementation completely ignores the &#8220;where&#8221; clause, &#8220;order&#8221; clause, and any other clause you can
name besides &#8220;select&#8221;.  It just returns the entire collection of items in the data source.</p>

<p>Up next, translating the where clause.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/08/20/how-the-motley-fool-uses-nuget-part-2/">How The Motley Fool Uses NuGet (Part 2)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/08/07/how-the-motley-fool-uses-nuget/">How The Motley Fool uses NuGet (part 1)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/07/26/MSBuild-NuGet-Visual-Studio-Hackery/">MSBuild, Visual Studio & NuGet Hackery</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/07/24/Unit-of-Work-and-Eventual-Consistency/">Unit of Work & Eventual Consistency</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/07/03/Speeding-Up-NuGet-Server/">Speeding Up NuGet.Server</a>
      </li>
    
  </ul>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("creldredge", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/creldredge" class="twitter-follow-button" data-show-count="false">Follow @creldredge</a>
  
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Chris Eldredge -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
