
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>QueueUserWorkItem, OWIN and you - Chris Eldredge</title>
  <meta name="author" content="Chris Eldredge">

  
  <meta name="description" content="QueueUserWorkItem, OWIN and You Sep 7th, 2014 There have been around elevnty billion posts on how to queue background work
from an asp.net app, why &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  

  <script type="text/javascript" src="//use.typekit.net/wvv4pst.js"></script>
  <script type="text/javascript">try{Typekit.load();}catch(e){}</script>

  <link rel="canonical" href="http://chris.eldredge.io/blog/2014/09/07/queueuserworkitem/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Chris Eldredge" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="/webfonts/ss-social-circle.css" rel="stylesheet" />

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-30472598-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   class="no-sidebar"  >
  <header role="banner" id="page-header"><hgroup>
  <h1><a href="/">Chris Eldredge</a></h1>
  
    <h2>software development with a splash of bitters</h2>
  
</hgroup>

</header>
  <div id="main">
    <div id="content">
      <article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">QueueUserWorkItem, OWIN and You</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-09-07T13:13:00-04:00" pubdate data-updated="true" class="meta-date">Sep 7<span>th</span>, 2014</time>
      </p>
    
  </header>



  <div class="entry-content"><p>There have been around elevnty billion posts on how to queue background work
from an asp.net app, why you shouldn&#8217;t do it, and what to do if you&#8217;re going
to do it despite being warned not to.</p>

<h2>Problems with Fire and Forget from ASP.NET</h2>

<p>Before ASP.NET 4.5.2, if a method with an <code>async void</code> signature is invoked
from a request-processing worker thread, or if an <code>async Task</code> method is invoked
and the resulting Task is not awaited, you get a big scary error in your
logs that looks like:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>TODO</span></code></pre></td></tr></table></div></figure>


<p>But you may have a legitimate reason to fire and forget a task. For example,
you may want to record something in your analytics, log something, send an email
and you don&#8217;t want the client request to block while these things are being done.</p>

<p>In the case of Klondike, whenever a package is downloaded, some counters need
to be incremented, and making the request block until this metric is recorded
and committed to disk only serves to slow down the client. The request still
succeeds if something goes wrong with incrementing the download counter.</p>

<p>Typically in asp.net architecture here&#8217;s where someone would suggest introducing
a background service, message bus, message queue, database to externalize
the record keeping so asp.net doesn&#8217;t have to deal with it.</p>

<p>However, making a simple app to distribute as a zip file conflicts with these
overly complex architectures. All because the asp.net application pool might
get recycled sometimes.</p>

<h2>QueueBackgroundWorkItem</h2>

<p>ASP.NET 4.5.2 introduced <a href="http://msdn.microsoft.com/en-us/library/system.web.hosting.hostingenvironment.queuebackgroundworkitem.aspx">HostingEnvironment.QueueBackgroundWorkItem</a> as an official way of queing
work from ASP.NET with some minimal guarantees that the process model will
be aware of and wait for the task to complete when the process is being
recycled or stopped.</p>

<p>The callbacks give you a cancellation token that gets triggered when the process
is being shut down (or recycled) and waits for some amount of time for tasks
to complete.</p>

<h2>Wither OWIN</h2>

<p>QueueBackgroundWorkItem is great if you&#8217;re only writing apps that will run
in asp.net. But for developers creating OWIN apps that support asp.net or
self-hosting, it isn&#8217;t obvious what should be done.</p>

<p>Another problem is that QueueBackgroundWorkItem is still so new that using
it directly means you probably won&#8217;t be compiling and running on mono any time
soon.</p>

<p>Both of these issues are problems for Klondike which aims to build and run
on mono and deploy as a self-hosted executable.</p>
</div>



    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://chris.eldredge.io/blog/2014/09/07/queueuserworkitem/" data-via="creldredge" data-counturl="http://chris.eldredge.io/blog/2014/09/07/queueuserworkitem/" >Tweet</a>
  
  
  
</div>

    

  <footer class="page-footer">
    <a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS" class="ss-icon rss">RSS</a>


  <form action="http://google.com/search" method="get">
    <input type="hidden" name="q" value="site:chris.eldredge.io" />
    <input class="search ss-search" type="text" name="q" results="0" />
  </form>



      <a class="prev-page" href="/blog/2014/05/01/node-plus-owin-living-in-the-future/" title="Previous Post: Node + Owin: Living in the Future">previous</a> |


    <a href="/blog/archives" class="see-more">archive</a>


      | <a class="next-page" href="/blog/2015/01/05/nuget-symbols-and-aspnet-vnext/" title="Next Post: NuGet Symbols and Aspnet vNext">next</a>

  </footer>

</article>

<section class="comments">
  <h1>Comments</h1>
  <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>

    </div>
  </div>
  <footer role="contentinfo" class="site-footer"><div class="bio">
  <h3>Chris Eldredge</h3>
  <p>Iâ€™m a software developer for <a href="http://www.fool.com/">The Motley Fool</a>. I tend to spend a lot of time on build and release tools. When I'm not hacking codes, I'm probably reading, cooking, drinking old-man drinks or studying Korean with <a href="http://ttmik.com/">TTMIK</a>.</p>
</div>
<ul class="social">
  <li><a href="https://www.github.com/chriseldredge" class="ss-icon">octocat</a></li>
  <li><a href="http://www.linkedin.com/pub/chris-eldredge/1/52b/520" class="ss-icon">linkedin</a></li>
  <li><a href="http://www.twitter.com/creldredge" class="ss-icon">twitter</a></li>
</ul>
<p class="copyright">
  Copyright &copy; 2015 - Chris Eldredge
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'chriseldredge';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://chris.eldredge.io/blog/2014/09/07/queueuserworkitem/';
        var disqus_url = 'http://chris.eldredge.io/blog/2014/09/07/queueuserworkitem/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
