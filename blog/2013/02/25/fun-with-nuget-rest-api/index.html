
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Fun with NuGet Web Api - Chris Eldredge</title>
  <meta name="author" content="Chris Eldredge">

  
  <meta name="description" content="NuGet is a package management system for .net. Like most things these days, NuGet uses HTTP
for client/server communication to enable search, &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://chriseldredge.github.com/blog/2013/02/25/fun-with-nuget-rest-api/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Chris Eldredge" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-30472598-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Chris Eldredge</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:chriseldredge.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/about/">About</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Fun With NuGet Web Api</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-25T10:57:00-05:00" pubdate data-updated="true">Feb 25<span>th</span>, 2013</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>NuGet is a package management system for .net. Like most things these days, NuGet uses HTTP
for client/server communication to enable search, download, upload and other operations.</p>

<p>Since I&#8217;ve been working on writing a NuGet web application, I have had the opportunity to
become intimately familiar with the web api and its wrinkles.</p>

<p>I was going to title this post &#8220;Fun with the NuGet REST Api&#8221;, but then I had to change it
because what NuGet does is pretty far from RESTful. The documentation for
<a href="https://github.com/NuGet/NuGetGallery/wiki/Tab-Completion-API-Endpoints">Tab Completion Endpoints</a>
openly acknowledges this, stating, &#8220;We currently don&#8217;t look at the Accept header or do lots of other
proper HTTP API stuff&#8221;. Caveat emptor.</p>

<p>There have been plenty of well written posts about what REST is and why most things that
speak json or xml over HTTP are not Restful.</p>

<ol>
<li><a href="http://kellabyte.com/2011/09/04/clarifying-rest/">Clarifying REST</a> from @kellabyte</li>
<li><a href="http://www.ics.uci.edu/~fielding/pubs/dissertation/rest_arch_style.htm">Representational State Transfer (REST)</a> Roy Fielding&#8217;s doctoral thesis</li>
<li><a href="http://roy.gbiv.com/untangled/2008/rest-apis-must-be-hypertext-driven">REST APIs must be hypertext-driven</a></li>
</ol>


<h2>WCF Data Services and REST</h2>

<p>NuGet has used WCF Data Services (OData) since inception to do the heavy lifting.
OData kind of sort of does a decent job of adhering to RESTful constraints and
using hyperlinks that give hints to clients about collections, entities and
functions that can be invoked on them.</p>

<p>Query the API Root:</p>

<pre><code>curl http://nuget.org/api/v2/

&lt;?xml version="1.0" encoding="utf-8" standalone="yes"?&gt;
&lt;service xml:base="http://nuget.org/api/v2/" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:app="http://www.w3.org/2007/app" xmlns="http://www.w3.org/2007/app"&gt;
  &lt;workspace&gt;
    &lt;atom:title&gt;Default&lt;/atom:title&gt;
    &lt;collection href="Packages"&gt;
      &lt;atom:title&gt;Packages&lt;/atom:title&gt;
    &lt;/collection&gt;
  &lt;/workspace&gt;
&lt;/service&gt;
</code></pre>

<p>You can see there&#8217;s a collection of Packages, and you even get an href that tells you where it is.</p>

<p>Unfortunately it does not tell you about the magic $metadata RPC call that gets you more
information about the entities contained in the Packages collection, and what other functions
are available:</p>

<pre><code>curl 'http://nuget.org/api/v2/$metadata'

&lt;?xml version="1.0" encoding="utf-8" standalone="yes"?&gt;
&lt;edmx:Edmx Version="1.0" xmlns:edmx="http://schemas.microsoft.com/ado/2007/06/edmx"&gt;
  &lt;edmx:DataServices xmlns:m="http://schemas.microsoft.com/ado/2007/08/dataservices/metadata" m:DataServiceVersion="2.0"&gt;
    &lt;Schema Namespace="NuGetGallery" xmlns:d="http://schemas.microsoft.com/ado/2007/08/dataservices" xmlns:m="http://schemas.microsoft.com/ado/2007/08/dataservices/metadata" xmlns="http://schemas.microsoft.com/ado/2006/04/edm"&gt;
      &lt;EntityType Name="V2FeedPackage" m:HasStream="true"&gt;
        &lt;Key&gt;
          &lt;PropertyRef Name="Id" /&gt;
          &lt;PropertyRef Name="Version" /&gt;
        &lt;/Key&gt;
        &lt;Property Name="Id" Type="Edm.String" Nullable="false" m:FC_TargetPath="SyndicationTitle" m:FC_ContentKind="text" m:FC_KeepInContent="false" /&gt;
        &lt;Property Name="Version" Type="Edm.String" Nullable="false" /&gt;
        &lt;Property Name="Authors" Type="Edm.String" Nullable="true" m:FC_TargetPath="SyndicationAuthorName" m:FC_ContentKind="text" m:FC_KeepInContent="false" /&gt;
        &lt;snip/&gt;
      &lt;/EntityType&gt;
      &lt;EntityContainer Name="FeedContext_x0060_1" m:IsDefaultEntityContainer="true"&gt;
        &lt;EntitySet Name="Packages" EntityType="NuGetGallery.V2FeedPackage" /&gt;
        &lt;FunctionImport Name="Search" EntitySet="Packages" ReturnType="Collection(NuGetGallery.V2FeedPackage)" m:HttpMethod="GET"&gt;
          &lt;Parameter Name="searchTerm" Type="Edm.String" Mode="In" /&gt;
          &lt;Parameter Name="includePrerelease" Type="Edm.Boolean" Mode="In" /&gt;
        &lt;/FunctionImport&gt;
        &lt;FunctionImport Name="FindPackagesById" EntitySet="Packages" ReturnType="Collection(NuGetGallery.V2FeedPackage)" m:HttpMethod="GET"&gt;
          &lt;Parameter Name="id" Type="Edm.String" Mode="In" /&gt;
        &lt;/FunctionImport&gt;
      &lt;/EntityContainer&gt;
    &lt;/Schema&gt;
  &lt;/edmx:DataServices&gt;
&lt;/edmx:Edmx&gt;
</code></pre>

<p>This xml vomit says that in addition to the hard-coded, out-of-band RPC API that is OData, you
can also invoke the Search and FindPackagesById functions, how to invoke them
and what parameters they take.</p>

<p>At some point the NuGet developers must have gotten sick of using WCF Data Services, because the endpoints for
uploading a package, deleting a package, and the tab completion endpoints all are implemented
without integration with WCF Data Services. That means that these operations are not discoverable
by a client, so if the client wants to invoke them it has to know their locations.</p>

<h2>The Evolution of a Public API</h2>

<p>When the client has no way of discovering available resources, that means the server can never
change the namespace of those resources, or risk breaking older clients.</p>

<p>SalesForce has at least 26 namespaced versions of some services which causes some problems
that @kellabyte discusses on a <a href="https://twitter.com/kellabyte/status/276661580257701889">twitter thread</a>.</p>

<p>NuGet in its current form uses /api/v2 for most HTTP API calls, and has managed to stay on v2 for a while
now. We&#8217;ve seen some new features get added without forcing everyone to move over to v3 yet.
The v1/v2 crutch should never have been introduced, but since it is we&#8217;re stuck with it.</p>

<h2>Dumb Servers and Dumber Clients</h2>

<p>Since the server won&#8217;t tell the client how to invoke certain operations, the client
must make assumptions and NuGet does exactly this. Badly.</p>

<p>The tab completion endpoints are predictably dumb. If you deploy a NuGet feed at
http://example.com/ and point Visual Studio to it, the PowerShell console will
try to go to http://example.com/api/v2/package-ids. If you deploy the same feed at
http://example.com/nuget, and point Visual Studio to that, the PowerShell console will
still try to go to http://example.com/api/v2/package-ids. Note how the /nuget/ part of
the namespace vanished. This will generally result in a 404.</p>

<p>Try to push or delete a package and things get more confusing. If you do
&#8220;nuget push Foo.nupkg -source http://example.com/&#8221;, instead of blindly appending
api/v2 to the URI, the client first does a GET request on the root URI.
If that GET request results in a 301/302 Redirect, the client will follow the redirect
and use that location to push the package. However, if the root URI returns some other
response code, the client reverts to dumbly hard-coding the path to api/v2/package.</p>

<p>But if you push to a URI that is not the root URI, the client listens to you
and pushes to whatever URI you told it.</p>

<p>What all of this means is that it is surprisingly hard to write a web application
that complies with all the weird shit that the NuGet client does. If you tell
Visual Studio that the package feed is at http://example.com/api/v2, then NuGet will
push to http://example.com/api/v2. But if you tell NuGet to publish to
http://example.com/ then it will publish to http://example.com/api/v2/package.</p>

<p>That means you need redundant routes to catch both cases.</p>

<h2>Example Routes</h2>

<p>For my application, here are the routes I came up with that seem to keep
the NuGet client happy, as long as you don&#8217;t deploy it as a child application:</p>

<div><script src='https://gist.github.com/5052423.js?file='></script>
<noscript><pre><code></code></pre></noscript></div>


<h2>Next</h2>

<p>I would love to see NuGet adopt more RESTful practices with regards to
its HTTP API, but having had one pull request declined already, I&#8217;m not sure
how eager I&#8217;ll be in trying to bring about this change.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Chris Eldredge</span></span>

      








  


<time datetime="2013-02-25T10:57:00-05:00" pubdate data-updated="true">Feb 25<span>th</span>, 2013</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://chriseldredge.github.com/blog/2013/02/25/fun-with-nuget-rest-api/" data-via="creldredge" data-counturl="http://chriseldredge.github.com/blog/2013/02/25/fun-with-nuget-rest-api/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2013/01/04/sitting-at-your-desk-is-killing-you/" title="Previous Post: Sitting at Your Desk is Killing You">&laquo; Sitting at Your Desk is Killing You</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/02/25/fun-with-nuget-rest-api/">Fun with NuGet Web Api</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/01/04/sitting-at-your-desk-is-killing-you/">Sitting at Your Desk is Killing You</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/09/21/ravendb-nuget-review/">RavenDB NuGet Review</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/09/06/how-the-motley-fool-uses-octopus-deploy/">How The Motley Fool Uses Octopus Deploy</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/08/20/how-the-motley-fool-uses-nuget-part-2/">How The Motley Fool Uses NuGet (Part 2)</a>
      </li>
    
  </ul>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("creldredge", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/creldredge" class="twitter-follow-button" data-show-count="false">Follow @creldredge</a>
  
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Chris Eldredge -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'chriseldredge';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://chriseldredge.github.com/blog/2013/02/25/fun-with-nuget-rest-api/';
        var disqus_url = 'http://chriseldredge.github.com/blog/2013/02/25/fun-with-nuget-rest-api/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
